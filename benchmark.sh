#!/bin/bash

if [ -z $1 ]; then
    echo "usage:"
    echo "benchmark.sh NAME"
    exit 1
fi

BENCHMARK_NAME="$1"
DIR="benchmarks/${BENCHMARK_NAME}"
BENCH_CSV=${BENCHMARK_NAME}.csv

#
# Run the benchmark
#

echo "last git commit id: $(git rev-parse HEAD)" > ${BENCH_CSV}
node run-server >> ${BENCH_CSV}

#
# Run the profiler
#

PROFILE=1 node run-server

#
# Code tracing: Get the IRHydra2 data
#

node  --trace-hydrogen                   \
      --trace-phase=Z                    \
      --trace-deopt                      \
      --code-comments                    \
      --hydrogen-track-positions         \
      --redirect-code-traces             \
      --redirect-code-traces-to=code.asm \
      run-server.js


#
# Save the config files
#

mkdir -p ${DIR}
rm ${DIR}/*
mv ${BENCH_CSV} ${DIR}                           # Generated by benchmark
mv profile.json ${DIR}/profile.json.cpuprofile   # Generated by profiler
mv code.asm ${DIR}                               # Generated by tracing
mv hydrogen-*.cfg ${DIR}                         # Generated by tracing
