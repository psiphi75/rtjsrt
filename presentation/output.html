<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="Docutils 0.12: http://docutils.sourceforge.net/" />
<title>High Perf Node.js</title>
<meta name="author" content="Simon Werner" />
<style type="text/css">

/*
:Author: David Goodger (goodger@python.org)
:Id: $Id: html4css1.css 7614 2013-02-21 15:55:51Z milde $
:Copyright: This stylesheet has been placed in the public domain.

Default cascading style sheet for the HTML output of Docutils.

See http://docutils.sf.net/docs/howto/html-stylesheets.html for how to
customize this style sheet.
*/

/* used to remove borders from tables and images */
.borderless, table.borderless td, table.borderless th {
  border: 0 }

table.borderless td, table.borderless th {
  /* Override padding for "table.docutils td" with "! important".
     The right padding separates the table cells. */
  padding: 0 0.5em 0 0 ! important }

.first {
  /* Override more specific margin styles with "! important". */
  margin-top: 0 ! important }

.last, .with-subtitle {
  margin-bottom: 0 ! important }

.hidden {
  display: none }

a.toc-backref {
  text-decoration: none ;
  color: black }

blockquote.epigraph {
  margin: 2em 5em ; }

dl.docutils dd {
  margin-bottom: 0.5em }

object[type="image/svg+xml"], object[type="application/x-shockwave-flash"] {
  overflow: hidden;
}

/* Uncomment (and remove this text!) to get bold-faced definition list terms
dl.docutils dt {
  font-weight: bold }
*/

div.abstract {
  margin: 2em 5em }

div.abstract p.topic-title {
  font-weight: bold ;
  text-align: center }

div.admonition, div.attention, div.caution, div.danger, div.error,
div.hint, div.important, div.note, div.tip, div.warning {
  margin: 2em ;
  border: medium outset ;
  padding: 1em }

div.admonition p.admonition-title, div.hint p.admonition-title,
div.important p.admonition-title, div.note p.admonition-title,
div.tip p.admonition-title {
  font-weight: bold ;
  font-family: sans-serif }

div.attention p.admonition-title, div.caution p.admonition-title,
div.danger p.admonition-title, div.error p.admonition-title,
div.warning p.admonition-title, .code .error {
  color: red ;
  font-weight: bold ;
  font-family: sans-serif }

/* Uncomment (and remove this text!) to get reduced vertical space in
   compound paragraphs.
div.compound .compound-first, div.compound .compound-middle {
  margin-bottom: 0.5em }

div.compound .compound-last, div.compound .compound-middle {
  margin-top: 0.5em }
*/

div.dedication {
  margin: 2em 5em ;
  text-align: center ;
  font-style: italic }

div.dedication p.topic-title {
  font-weight: bold ;
  font-style: normal }

div.figure {
  margin-left: 2em ;
  margin-right: 2em }

div.footer, div.header {
  clear: both;
  font-size: smaller }

div.line-block {
  display: block ;
  margin-top: 1em ;
  margin-bottom: 1em }

div.line-block div.line-block {
  margin-top: 0 ;
  margin-bottom: 0 ;
  margin-left: 1.5em }

div.sidebar {
  margin: 0 0 0.5em 1em ;
  border: medium outset ;
  padding: 1em ;
  background-color: #ffffee ;
  width: 40% ;
  float: right ;
  clear: right }

div.sidebar p.rubric {
  font-family: sans-serif ;
  font-size: medium }

div.system-messages {
  margin: 5em }

div.system-messages h1 {
  color: red }

div.system-message {
  border: medium outset ;
  padding: 1em }

div.system-message p.system-message-title {
  color: red ;
  font-weight: bold }

div.topic {
  margin: 2em }

h1.section-subtitle, h2.section-subtitle, h3.section-subtitle,
h4.section-subtitle, h5.section-subtitle, h6.section-subtitle {
  margin-top: 0.4em }

h1.title {
  text-align: center }

h2.subtitle {
  text-align: center }

hr.docutils {
  width: 75% }

img.align-left, .figure.align-left, object.align-left {
  clear: left ;
  float: left ;
  margin-right: 1em }

img.align-right, .figure.align-right, object.align-right {
  clear: right ;
  float: right ;
  margin-left: 1em }

img.align-center, .figure.align-center, object.align-center {
  display: block;
  margin-left: auto;
  margin-right: auto;
}

.align-left {
  text-align: left }

.align-center {
  clear: both ;
  text-align: center }

.align-right {
  text-align: right }

/* reset inner alignment in figures */
div.align-right {
  text-align: inherit }

/* div.align-center * { */
/*   text-align: left } */

ol.simple, ul.simple {
  margin-bottom: 1em }

ol.arabic {
  list-style: decimal }

ol.loweralpha {
  list-style: lower-alpha }

ol.upperalpha {
  list-style: upper-alpha }

ol.lowerroman {
  list-style: lower-roman }

ol.upperroman {
  list-style: upper-roman }

p.attribution {
  text-align: right ;
  margin-left: 50% }

p.caption {
  font-style: italic }

p.credits {
  font-style: italic ;
  font-size: smaller }

p.label {
  white-space: nowrap }

p.rubric {
  font-weight: bold ;
  font-size: larger ;
  color: maroon ;
  text-align: center }

p.sidebar-title {
  font-family: sans-serif ;
  font-weight: bold ;
  font-size: larger }

p.sidebar-subtitle {
  font-family: sans-serif ;
  font-weight: bold }

p.topic-title {
  font-weight: bold }

pre.address {
  margin-bottom: 0 ;
  margin-top: 0 ;
  font: inherit }

pre.literal-block, pre.doctest-block, pre.math, pre.code {
  margin-left: 2em ;
  margin-right: 2em }

pre.code .ln { color: grey; } /* line numbers */
pre.code, code { background-color: #eeeeee }
pre.code .comment, code .comment { color: #5C6576 }
pre.code .keyword, code .keyword { color: #3B0D06; font-weight: bold }
pre.code .literal.string, code .literal.string { color: #0C5404 }
pre.code .name.builtin, code .name.builtin { color: #352B84 }
pre.code .deleted, code .deleted { background-color: #DEB0A1}
pre.code .inserted, code .inserted { background-color: #A3D289}

span.classifier {
  font-family: sans-serif ;
  font-style: oblique }

span.classifier-delimiter {
  font-family: sans-serif ;
  font-weight: bold }

span.interpreted {
  font-family: sans-serif }

span.option {
  white-space: nowrap }

span.pre {
  white-space: pre }

span.problematic {
  color: red }

span.section-subtitle {
  /* font-size relative to parent (h1..h6 element) */
  font-size: 80% }

table.citation {
  border-left: solid 1px gray;
  margin-left: 1px }

table.docinfo {
  margin: 2em 4em }

table.docutils {
  margin-top: 0.5em ;
  margin-bottom: 0.5em }

table.footnote {
  border-left: solid 1px black;
  margin-left: 1px }

table.docutils td, table.docutils th,
table.docinfo td, table.docinfo th {
  padding-left: 0.5em ;
  padding-right: 0.5em ;
  vertical-align: top }

table.docutils th.field-name, table.docinfo th.docinfo-name {
  font-weight: bold ;
  text-align: left ;
  white-space: nowrap ;
  padding-left: 0 }

/* "booktabs" style (no vertical lines) */
table.docutils.booktabs {
  border: 0px;
  border-top: 2px solid;
  border-bottom: 2px solid;
  border-collapse: collapse;
}
table.docutils.booktabs * {
  border: 0px;
}
table.docutils.booktabs th {
  border-bottom: thin solid;
  text-align: left;
}

h1 tt.docutils, h2 tt.docutils, h3 tt.docutils,
h4 tt.docutils, h5 tt.docutils, h6 tt.docutils {
  font-size: 100% }

ul.auto-toc {
  list-style-type: none }

</style>
</head>
<body>
<div class="document">

<table class="docinfo" frame="void" rules="none">
<col class="docinfo-name" />
<col class="docinfo-content" />
<tbody valign="top">
<tr class="field"><th class="docinfo-name" colspan="2">data-transition-duration:</th></tr>
<tr class="field"><td>&nbsp;</td><td class="field-body">400</td>
</tr>
<tr><th class="docinfo-name">Author:</th>
<td>Simon Werner</td></tr>
<tr class="field"><th class="docinfo-name">skip-help:</th><td class="field-body">false</td>
</tr>
<tr class="field"><th class="docinfo-name">css:</th><td class="field-body">style.css</td>
</tr>
</tbody>
</table>
<div class="note">
<p class="first admonition-title">Note</p>
<ul class="last">
<li><dl class="first docutils">
<dt>Preparation:</dt>
<dd><ul class="first last simple">
<li>Network</li>
</ul>
</dd>
</dl>
</li>
</ul>
</div>
<hr class="docutils" />
<div class="section" id="optimising-node-js-for-speed">
<h1>Optimising Node.js for Speed</h1>
<div class="system-message">
<p class="system-message-title">System Message: ERROR/3 (<tt class="docutils">presentation.rst</tt>, line 16)</p>
Document or section may not begin with a transition.</div>
</div>
<hr class="docutils" />
<div class="section" id="disclaimer-1">
<h1>DISCLAIMER #1</h1>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul class="simple">
<li>Optimising is bad for your health</li>
<li>Don't try this at home children</li>
<li>Don't believe what I say</li>
<li>Don't write a RayTracer in JavaScript</li>
<li>Poor performace <tt class="docutils literal">!==</tt> bad programming</li>
</ul>
</div>
<hr class="docutils" />
<div class="section" id="disclaimer-2">
<h1>DISCLAIMER #2</h1>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p><strong>Don't make assumptions</strong></p>
</div>
<hr class="docutils" />
<div class="section" id="disclaimer-3">
<h1>DISCLAIMER #3</h1>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>Donald Knuth:</p>
<blockquote>
<em>premature optimization is the root of all evil.</em></blockquote>
</div>
<hr class="docutils" />
<div class="section" id="id1">
<h1>Optimising Node.js for Speed</h1>
<ol class="arabic simple">
<li>WTF is RayTracing?</li>
<li>The Optimisation Process</li>
<li>Benchmarking and Profiling</li>
<li>Understand the compiler</li>
<li>Multi-threading</li>
<li>Node-gyp</li>
<li>Upcoming JavaScript Features</li>
</ol>
</div>
<hr class="docutils" />
<div class="section" id="wtf-is-raytracing">
<h1>WTF is RayTracing?</h1>
<img alt="Ray-tracedVsRasterized.jpg" src="Ray-tracedVsRasterized.jpg" />
</div>
<hr class="docutils" />
<div class="section" id="id2">
<h1>WTF is RayTracing?</h1>
<ul class="simple">
<li>Photo realistic scenes</li>
<li>Highly mathematical</li>
<li>Computationally intensive</li>
<li>Not your standard Node.js process</li>
<li>The <a class="reference external" href="http://rtjsrt.s3-website-ap-southeast-2.amazonaws.com/v1-updated-vector/">un-optimised</a> RayTracer</li>
</ul>
</div>
<hr class="docutils" />
<div class="section" id="the-optimisation-process">
<h1>The Optimisation Process</h1>
<div class="system-message">
<p class="system-message-title">System Message: ERROR/3 (<tt class="docutils">presentation.rst</tt>, line 85)</p>
Document or section may not begin with a transition.</div>
</div>
<hr class="docutils" />
<div class="section" id="id3">
<h1>The Optimisation Process</h1>
<ol class="arabic simple">
<li>Start with clean code</li>
<li>Test using a benchmark / profiler</li>
<li>Identify the bottleneck</li>
<li>Update the code</li>
<li>Repeat steps 2. to 5.</li>
<li>STOP</li>
</ol>
</div>
<hr class="docutils" />
<div class="section" id="benchmarking-and-profiling">
<h1>Benchmarking and Profiling</h1>
<div class="system-message">
<p class="system-message-title">System Message: ERROR/3 (<tt class="docutils">presentation.rst</tt>, line 102)</p>
Document or section may not begin with a transition.</div>
</div>
<hr class="docutils" />
<div class="section" id="benchmarking-vs-profiling">
<h1>Benchmarking vs Profiling</h1>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p><strong>Profiling</strong></p>
<ul class="simple">
<li>Looks at whole application workflow</li>
<li>Used to find bottle necks</li>
</ul>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p><strong>Benchmark</strong></p>
<blockquote>
<ol class="arabic simple">
<li>measure performance (before)</li>
<li>improve code</li>
<li>measure performance (after)</li>
</ol>
</blockquote>
</div>
<hr class="docutils" />
<div class="section" id="benchmarking-with-simple-timers">
<h1>Benchmarking with Simple Timers</h1>
<div class="line-block">
<div class="line"><br /></div>
</div>
<pre class="code javascript literal-block">
<span class="keyword reserved">const</span> <span class="name other">start</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="name builtin">Date</span><span class="punctuation">.</span><span class="name other">getTime</span><span class="punctuation">();</span>

<span class="comment single">// ... your slow code ...
</span>
<span class="keyword reserved">const</span> <span class="name other">end</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="name builtin">Date</span><span class="punctuation">.</span><span class="name other">getTime</span><span class="punctuation">();</span>
<span class="name other">console</span><span class="punctuation">.</span><span class="name other">log</span><span class="punctuation">(</span><span class="literal string backtick">`Time taken (ms): </span><span class="literal string interpol">${</span><span class="name other">end</span> <span class="operator">-</span> <span class="name other">start</span><span class="literal string interpol">}</span><span class="literal string backtick">`</span><span class="punctuation">);</span>

<span class="comment single">// Time taken (ms): 1245</span>
</pre>
</div>
<hr class="docutils" />
<div class="section" id="performance-now">
<h1><tt class="docutils literal">performance.now()</tt></h1>
<ul class="simple">
<li>native in browser</li>
<li>npm <a class="reference external" href="https://www.npmjs.com/package/performance-now">package</a> for Node.js</li>
</ul>
</div>
<hr class="docutils" />
<div class="section" id="the-v8-profiler">
<h1>The V8 profiler</h1>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>V8 comes with built-in profiler:</p>
<pre class="code javascript literal-block">
<span class="keyword reserved">const</span> <span class="name other">profiler</span> <span class="operator">=</span> <span class="name other">require</span><span class="punctuation">(</span><span class="literal string single">'v8-profiler'</span><span class="punctuation">);</span>

<span class="keyword">if</span> <span class="punctuation">(</span><span class="name other">startProfiling</span> <span class="operator">===</span> <span class="keyword constant">true</span><span class="punctuation">)</span> <span class="punctuation">{</span>
    <span class="name other">profiler</span><span class="punctuation">.</span><span class="name other">startProfiling</span><span class="punctuation">();</span>
<span class="punctuation">}</span>

<span class="comment single">// ... let code run for a few seconds/minutes
</span>
<span class="keyword">if</span> <span class="punctuation">(</span><span class="name other">stopProfiling</span> <span class="operator">===</span> <span class="keyword constant">true</span><span class="punctuation">)</span> <span class="punctuation">{</span>
    <span class="name other">profiler</span><span class="punctuation">.</span><span class="name other">stopProfiling</span><span class="punctuation">()</span>
            <span class="punctuation">.</span><span class="keyword reserved">export</span><span class="punctuation">(</span><span class="keyword declaration">function</span> <span class="name other">exportFunction</span><span class="punctuation">(</span><span class="name other">err</span><span class="punctuation">,</span> <span class="name other">res</span><span class="punctuation">)</span> <span class="punctuation">{</span>
                <span class="keyword reserved">const</span> <span class="name other">fs</span> <span class="operator">=</span> <span class="name other">require</span><span class="punctuation">(</span><span class="literal string single">'fs'</span><span class="punctuation">);</span>
                <span class="name other">fs</span><span class="punctuation">.</span><span class="name other">writeFileSync</span><span class="punctuation">(</span><span class="literal string single">'app.cpuprofile'</span><span class="punctuation">,</span> <span class="name other">res</span><span class="punctuation">);</span>
            <span class="punctuation">});</span>
<span class="punctuation">}</span>
</pre>
</div>
<hr class="docutils" />
<div class="section" id="id4">
<h1>The V8 profiler</h1>
<p>Open in Chrome developer tools</p>
<img alt="devTools.png" src="devTools.png" style="width: 960px;" />
</div>
<hr class="docutils" />
<div class="section" id="improving-dot">
<h1>Improving <tt class="docutils literal">.dot()</tt>:</h1>
<div class="line-block">
<div class="line"><br /></div>
</div>
<pre class="code javascript literal-block">
<span class="comment single">// Before - slow
</span><span class="keyword declaration">function</span> <span class="name other">dot</span><span class="punctuation">(</span><span class="name other">v</span><span class="punctuation">,</span> <span class="name other">w</span><span class="punctuation">)</span> <span class="punctuation">{</span>
    <span class="keyword">return</span> <span class="punctuation">(</span><span class="name other">v</span><span class="punctuation">[</span><span class="literal number integer">0</span><span class="punctuation">]</span> <span class="operator">*</span> <span class="name other">w</span><span class="punctuation">[</span><span class="literal number integer">0</span><span class="punctuation">]</span> <span class="operator">+</span> <span class="name other">v</span><span class="punctuation">[</span><span class="literal number integer">1</span><span class="punctuation">]</span> <span class="operator">*</span> <span class="name other">w</span><span class="punctuation">[</span><span class="literal number integer">1</span><span class="punctuation">]</span> <span class="operator">+</span> <span class="name other">v</span><span class="punctuation">[</span><span class="literal number integer">2</span><span class="punctuation">]</span> <span class="operator">*</span> <span class="name other">w</span><span class="punctuation">[</span><span class="literal number integer">2</span><span class="punctuation">]);</span>
<span class="punctuation">}</span>

<span class="comment single">// After - 2x times faster
</span><span class="name other">Vector</span><span class="punctuation">.</span><span class="name other">prototype</span><span class="punctuation">.</span><span class="name other">dot</span> <span class="operator">=</span> <span class="keyword declaration">function</span><span class="punctuation">(</span><span class="name other">w</span><span class="punctuation">)</span> <span class="punctuation">{</span>
    <span class="keyword">return</span> <span class="keyword">this</span><span class="punctuation">.</span><span class="name other">x</span> <span class="operator">*</span> <span class="name other">w</span><span class="punctuation">.</span><span class="name other">x</span> <span class="operator">+</span> <span class="keyword">this</span><span class="punctuation">.</span><span class="name other">y</span> <span class="operator">*</span> <span class="name other">w</span><span class="punctuation">.</span><span class="name other">y</span> <span class="operator">+</span> <span class="keyword">this</span><span class="punctuation">.</span><span class="name other">z</span> <span class="operator">*</span> <span class="name other">w</span><span class="punctuation">.</span><span class="name other">z</span><span class="punctuation">;</span>
<span class="punctuation">};</span>
</pre>
</div>
<hr class="docutils" />
<div class="section" id="other-profiling-tools">
<h1>Other profiling tools</h1>
<p>Comprehensive suites (client to db):</p>
<ul class="simple">
<li>New Relic (<a class="reference external" href="NewRelic.png">img</a>)</li>
<li>AppDynamics</li>
<li>Dynatrace</li>
</ul>
<p>Low level:</p>
<ul class="simple">
<li><a class="reference external" href="http://mrale.ph/irhydra/2/">IRHydra²</a> - shows generated assembly code</li>
<li>Linux Kernel (perf, dtrace, etc)</li>
</ul>
</div>
<hr class="docutils" />
<div class="section" id="understand-the-compiler">
<h1>Understand the compiler</h1>
<div class="system-message">
<p class="system-message-title">System Message: ERROR/3 (<tt class="docutils">presentation.rst</tt>, line 230)</p>
Document or section may not begin with a transition.</div>
</div>
<hr class="docutils" />
<div class="section" id="id5">
<h1>Understand the compiler</h1>
<div class="line-block">
<div class="line"><br /></div>
</div>
<img alt="Compiler.png" src="Compiler.png" style="width: 960px;" />
</div>
<hr class="docutils" />
<div class="section" id="the-current-v8-compiler">
<h1>The current V8 compiler</h1>
<img alt="CurrentV8.png" src="CurrentV8.png" style="width: 960px;" />
<div class="line-block">
<div class="line"><br /></div>
<div class="line"><br /></div>
<div class="line"><br /></div>
<div class="line"><br /></div>
<div class="line"><br /></div>
</div>
</div>
<hr class="docutils" />
<div class="section" id="id6">
<h1>The current V8 compiler</h1>
<img alt="CurrentV8.png" src="CurrentV8.png" style="width: 960px;" />
</div>
<div class="section" id="the-future-v8-compiler">
<h1>The future V8 compiler</h1>
<img alt="FutureV8.png" src="FutureV8.png" style="width: 960px;" />
</div>
<hr class="docutils" />
<div class="section" id="es6-new-features">
<h1>ES6 + New Features</h1>
<ul class="simple">
<li><tt class="docutils literal">let</tt>, <tt class="docutils literal">const</tt> slower than <tt class="docutils literal">var</tt></li>
<li>new JavaScript features tend to be slow</li>
</ul>
</div>
<hr class="docutils" />
<div class="section" id="jsperf-com">
<h1>JSPerf.com</h1>
<ul class="simple">
<li>Benchmark code snippets</li>
<li>Performance quirks</li>
<li>Some tests are very poorly written</li>
</ul>
</div>
<hr class="docutils" />
<div class="section" id="avoid-hidden-classes">
<h1>Avoid hidden classes</h1>
<p>Keep to the original definition, if you can.</p>
<pre class="code javascript literal-block">
<span class="name other">fuction</span> <span class="name other">vector</span><span class="punctuation">(</span><span class="name other">x</span><span class="punctuation">,</span> <span class="name other">y</span><span class="punctuation">)</span> <span class="punctuation">{</span>
    <span class="keyword">this</span><span class="punctuation">.</span><span class="name other">x</span> <span class="operator">=</span> <span class="name other">x</span><span class="punctuation">;</span>
    <span class="keyword">this</span><span class="punctuation">.</span><span class="name other">y</span> <span class="operator">=</span> <span class="name other">y</span><span class="punctuation">;</span>
<span class="punctuation">}</span>

<span class="keyword reserved">const</span> <span class="name other">a</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="name other">vector</span><span class="punctuation">(</span><span class="literal number integer">1</span><span class="punctuation">,</span> <span class="literal number integer">2</span><span class="punctuation">);</span>
<span class="keyword reserved">const</span> <span class="name other">b</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="name other">vector</span><span class="punctuation">(</span><span class="literal number integer">3</span><span class="punctuation">,</span> <span class="literal number integer">4</span><span class="punctuation">);</span> <span class="comment single">// OKAY: b has the same hidden class as a
</span><span class="name other">b</span><span class="punctuation">.</span><span class="name other">z</span> <span class="operator">=</span> <span class="literal number integer">5</span><span class="punctuation">;</span>                    <span class="comment single">// BAD: b now has a different hidden class</span>
</pre>
</div>
<hr class="docutils" />
<div class="section" id="avoid-polymorphic-classes">
<h1>Avoid polymorphic classes</h1>
<p>Difficult for compiler to optimise.</p>
<pre class="code javascript literal-block">
<span class="keyword declaration">function</span> <span class="name other">add</span><span class="punctuation">(</span><span class="name other">a</span><span class="punctuation">,</span> <span class="name other">b</span><span class="punctuation">)</span>         <span class="keyword">return</span> <span class="name other">a</span> <span class="operator">+</span> <span class="name other">b</span><span class="punctuation">;</span>
<span class="punctuation">}</span>
<span class="name other">add</span><span class="punctuation">(</span><span class="literal number integer">1</span><span class="punctuation">,</span> <span class="literal number integer">2</span><span class="punctuation">);</span>      <span class="comment single">// OKAY: Starts as monomorphic
</span><span class="name other">add</span><span class="punctuation">(</span><span class="literal number integer">2</span><span class="punctuation">,</span> <span class="literal number integer">3</span><span class="punctuation">);</span>      <span class="comment single">// OKAY: Still monomorphic
</span><span class="name other">add</span><span class="punctuation">(</span><span class="literal string single">'x'</span><span class="punctuation">,</span> <span class="literal string single">'y'</span><span class="punctuation">);</span>  <span class="comment single">// BAD: Now becomes polymorphic</span>
</pre>
<p><a class="reference external" href="https://jsperf.com/monomorphism-vs-polymorphism/3">jsperf.com/monomorphism-vs-polymorphism/3</a></p>
</div>
<hr class="docutils" />
<div class="section" id="avoid-factory-functions">
<h1>Avoid Factory Functions</h1>
<pre class="code javascript literal-block">
<span class="keyword declaration">function</span> <span class="name other">createValueObject</span><span class="punctuation">()</span> <span class="punctuation">{</span>
    <span class="keyword declaration">var</span> <span class="name other">x</span> <span class="operator">=</span> <span class="literal number integer">0</span><span class="punctuation">;</span>

    <span class="keyword declaration">function</span> <span class="name other">get</span><span class="punctuation">()</span> <span class="punctuation">{</span>
        <span class="keyword">return</span> <span class="name other">x</span><span class="punctuation">;</span>
    <span class="punctuation">}</span>

    <span class="keyword declaration">function</span> <span class="name other">add</span><span class="punctuation">(</span><span class="name other">y</span><span class="punctuation">)</span> <span class="punctuation">{</span>
        <span class="name other">x</span> <span class="operator">+=</span> <span class="name other">y</span><span class="punctuation">;</span>
    <span class="punctuation">}</span>

    <span class="keyword">return</span> <span class="punctuation">{</span>
        <span class="name other">get</span><span class="operator">:</span> <span class="name other">get</span><span class="punctuation">,</span>
        <span class="name other">add</span><span class="operator">:</span> <span class="name other">add</span><span class="punctuation">,</span>
    <span class="punctuation">};</span>
<span class="punctuation">}</span>
</pre>
<p><a class="reference external" href="https://jsperf.com/prototype-vs-factory-vs-class">jsperf.com/prototype-vs-factory-vs-class</a></p>
</div>
<hr class="docutils" />
<div class="section" id="foreach-vs-for">
<h1>forEach vs for</h1>
<pre class="code javascript literal-block">
<span class="name other">values</span><span class="punctuation">.</span><span class="name other">forEach</span><span class="punctuation">(</span><span class="name other">add</span><span class="punctuation">);</span>

<span class="comment single">// vs
</span>
<span class="keyword">for</span> <span class="punctuation">(</span><span class="name other">i</span> <span class="operator">=</span> <span class="literal number integer">0</span><span class="punctuation">;</span> <span class="name other">i</span> <span class="operator">&lt;</span> <span class="name other">values</span><span class="punctuation">.</span><span class="name other">length</span><span class="punctuation">;</span> <span class="name other">i</span><span class="operator">++</span><span class="punctuation">)</span> <span class="punctuation">{</span>
    <span class="name other">add</span><span class="punctuation">(</span><span class="name other">values</span><span class="punctuation">[</span><span class="name other">i</span><span class="punctuation">]);</span>
<span class="punctuation">}</span>
</pre>
<p><a class="reference external" href="https://jsperf.com/for-vs-foreach">jsperf.com/for-vs-foreach</a></p>
</div>
<hr class="docutils" />
<div class="section" id="multi-threading">
<h1>Multi-threading</h1>
<div class="system-message">
<p class="system-message-title">System Message: ERROR/3 (<tt class="docutils">presentation.rst</tt>, line 369)</p>
Document or section may not begin with a transition.</div>
</div>
<hr class="docutils" />
<div class="section" id="multi-threading-in-node-js">
<h1>Multi-threading in Node.js</h1>
<ul>
<li><p class="first">By default JavaScript is single threaded</p>
</li>
<li><p class="first">Multi-threading:</p>
<blockquote>
<ul class="simple">
<li>Browser: Web Workers</li>
<li>Node.js: Cluster (native)</li>
<li>npm library: <tt class="docutils literal">workerjs</tt></li>
</ul>
</blockquote>
</li>
</ul>
</div>
<hr class="docutils" />
<div class="section" id="master-worker">
<h1>Master / Worker</h1>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p><tt class="docutils literal">master.js</tt>:</p>
<pre class="code javascript literal-block">
<span class="keyword reserved">const</span> <span class="name other">Worker</span> <span class="operator">=</span> <span class="name other">require</span><span class="punctuation">(</span><span class="literal string single">'workerjs'</span><span class="punctuation">);</span>
<span class="keyword reserved">const</span> <span class="name other">worker1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="name other">Worker</span><span class="punctuation">(</span><span class="literal string single">'myWorker.js'</span><span class="punctuation">);</span>

<span class="name other">worker1</span><span class="punctuation">.</span><span class="name other">addEventListener</span><span class="punctuation">(</span><span class="literal string single">'message'</span><span class="punctuation">,</span>
            <span class="punctuation">(</span><span class="name other">workerMsg</span><span class="punctuation">)</span> <span class="operator">==&gt;</span> <span class="punctuation">{</span>
                <span class="comment single">// ... do something with the result
</span>            <span class="punctuation">});</span>

<span class="name other">worker1</span><span class="punctuation">.</span><span class="name other">postMessage</span><span class="punctuation">(</span><span class="literal string single">'Start your work'</span><span class="punctuation">);</span>
</pre>
<hr class="docutils" />
<p><tt class="docutils literal">myWorker.js</tt>:</p>
<pre class="code javascript literal-block">
<span class="keyword">this</span><span class="punctuation">.</span><span class="name other">addEventListener</span><span class="punctuation">(</span><span class="literal string single">'message'</span><span class="punctuation">,</span> <span class="keyword declaration">function</span><span class="punctuation">(</span><span class="name other">e</span><span class="punctuation">)</span> <span class="punctuation">{</span>

    <span class="keyword">if</span> <span class="punctuation">(</span><span class="name other">e</span><span class="punctuation">.</span><span class="name other">message</span> <span class="operator">===</span> <span class="literal string single">'Start your work'</span><span class="punctuation">)</span> <span class="punctuation">{</span>

        <span class="comment single">// Do lots of work
</span>        <span class="keyword reserved">const</span> <span class="name other">result</span> <span class="operator">=</span> <span class="name other">rayTrace</span><span class="punctuation">();</span>

        <span class="keyword">this</span><span class="punctuation">.</span><span class="name other">postMessage</span><span class="punctuation">(</span><span class="name other">result</span><span class="punctuation">);</span>
    <span class="punctuation">}</span>

<span class="punctuation">},</span> <span class="keyword constant">false</span><span class="punctuation">);</span>
</pre>
</div>
<hr class="docutils" />
<div class="section" id="multi-threading-results">
<h1>Multi-threading results</h1>
<div class="line-block">
<div class="line"><br /></div>
</div>
<img alt="multithreading.png" src="multithreading.png" style="width: 960px;" />
<p><a class="reference external" href="http://rtjsrt.s3-website-ap-southeast-2.amazonaws.com/v3-final/">RayTracer</a></p>
</div>
<hr class="docutils" />
<div class="section" id="node-gyp">
<h1>node-gyp</h1>
<div class="system-message">
<p class="system-message-title">System Message: ERROR/3 (<tt class="docutils">presentation.rst</tt>, line 437)</p>
Document or section may not begin with a transition.</div>
</div>
<hr class="docutils" />
<div class="section" id="id7">
<h1>node-gyp</h1>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul class="simple">
<li>Binds C++ to V8</li>
<li>Used to develop core Node.js modules</li>
<li>Many npm libraries use it</li>
<li>Can use for:<ul>
<li>binding to external libraries</li>
<li>performance improvements</li>
</ul>
</li>
</ul>
</div>
<hr class="docutils" />
<div class="section" id="node-gyp-drawbacks">
<h1>node-gyp - drawbacks</h1>
<div class="line-block">
<div class="line"><br /></div>
</div>
<ul class="simple">
<li>Need to know C++</li>
<li>Significant effort for writing C++/JS interface</li>
<li>May need to maintain 2 code bases</li>
<li>Need to unpack and pack values</li>
</ul>
</div>
<hr class="docutils" />
<div class="section" id="let-s-write-this-in-c">
<h1>Let's write this in C++</h1>
<div class="line-block">
<div class="line"><br /></div>
</div>
<pre class="code javascript literal-block">
<span class="name other">module</span><span class="punctuation">.</span><span class="name other">exports</span><span class="punctuation">.</span><span class="name other">hello</span> <span class="operator">=</span> <span class="punctuation">()</span> <span class="operator">=&gt;</span> <span class="literal string single">'world'</span><span class="punctuation">;</span>
</pre>
</div>
<hr class="docutils" />
<div class="section" id="file-structure">
<h1>File structure</h1>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p><tt class="docutils literal">\addon.cc</tt></p>
<p><tt class="docutils literal">\bindings.gyp</tt></p>
<p><tt class="docutils literal">\hello.js</tt></p>
<p><tt class="docutils literal">\build\</tt></p>
<hr class="docutils" />
<p><tt class="docutils literal">addon.cc</tt>:</p>
<pre class="code Cpp literal-block">
<span class="comment preproc">#include</span> <span class="comment preprocfile">&lt;node.h&gt;</span><span class="comment preproc">
</span>
<span class="keyword">namespace</span> <span class="name">demo</span> <span class="punctuation">{</span>

<span class="keyword">using</span> <span class="name">v8</span><span class="operator">::</span><span class="name">FunctionCallbackInfo</span><span class="punctuation">;</span>
<span class="keyword">using</span> <span class="name">v8</span><span class="operator">::</span><span class="name">Isolate</span><span class="punctuation">;</span>
<span class="keyword">using</span> <span class="name">v8</span><span class="operator">::</span><span class="name">Local</span><span class="punctuation">;</span>
<span class="keyword">using</span> <span class="name">v8</span><span class="operator">::</span><span class="name">Object</span><span class="punctuation">;</span>
<span class="keyword">using</span> <span class="name">v8</span><span class="operator">::</span><span class="name">String</span><span class="punctuation">;</span>
<span class="keyword">using</span> <span class="name">v8</span><span class="operator">::</span><span class="name">Value</span><span class="punctuation">;</span>

<span class="keyword type">void</span> <span class="name function">Method</span><span class="punctuation">(</span><span class="keyword">const</span> <span class="name">FunctionCallbackInfo</span><span class="operator">&lt;</span><span class="name">Value</span><span class="operator">&gt;&amp;</span> <span class="name">args</span><span class="punctuation">)</span> <span class="punctuation">{</span>
  <span class="name">Isolate</span><span class="operator">*</span> <span class="name">isolate</span> <span class="operator">=</span> <span class="name">args</span><span class="punctuation">.</span><span class="name">GetIsolate</span><span class="punctuation">();</span>
  <span class="name">args</span><span class="punctuation">.</span><span class="name">GetReturnValue</span><span class="punctuation">().</span><span class="name">Set</span><span class="punctuation">(</span><span class="name">String</span><span class="operator">::</span><span class="name">NewFromUtf8</span><span class="punctuation">(</span><span class="name">isolate</span><span class="punctuation">,</span> <span class="literal string">&quot;world&quot;</span><span class="punctuation">));</span>
<span class="punctuation">}</span>

<span class="keyword type">void</span> <span class="name function">init</span><span class="punctuation">(</span><span class="name">Local</span><span class="operator">&lt;</span><span class="name">Object</span><span class="operator">&gt;</span> <span class="name">exports</span><span class="punctuation">)</span> <span class="punctuation">{</span>
  <span class="name">NODE_SET_METHOD</span><span class="punctuation">(</span><span class="name">exports</span><span class="punctuation">,</span> <span class="literal string">&quot;hello&quot;</span><span class="punctuation">,</span> <span class="name">Method</span><span class="punctuation">);</span>
<span class="punctuation">}</span>

<span class="name">NODE_MODULE</span><span class="punctuation">(</span><span class="name">addon</span><span class="punctuation">,</span> <span class="name">init</span><span class="punctuation">)</span>

<span class="punctuation">}</span>  <span class="comment single">// namespace demo</span>
</pre>
<hr class="docutils" />
<p><tt class="docutils literal">binding.gyp</tt>:</p>
<div class="line-block">
<div class="line"><br /></div>
</div>
<pre class="code javascript literal-block">
<span class="punctuation">{</span>
  <span class="literal string double">&quot;targets&quot;</span><span class="operator">:</span> <span class="punctuation">[</span>
    <span class="punctuation">{</span>
      <span class="literal string double">&quot;target_name&quot;</span><span class="operator">:</span> <span class="literal string double">&quot;addon&quot;</span><span class="punctuation">,</span>
      <span class="literal string double">&quot;sources&quot;</span><span class="operator">:</span> <span class="punctuation">[</span> <span class="literal string double">&quot;addon.cc&quot;</span> <span class="punctuation">]</span>
    <span class="punctuation">}</span>
  <span class="punctuation">]</span>
<span class="punctuation">}</span>
</pre>
<hr class="docutils" />
<p><tt class="docutils literal">hello.js</tt>:</p>
<div class="line-block">
<div class="line"><br /></div>
</div>
<pre class="code javascript literal-block">
<span class="keyword reserved">const</span> <span class="name other">addon</span> <span class="operator">=</span> <span class="name other">require</span><span class="punctuation">(</span><span class="literal string single">'./build/Release/addon'</span><span class="punctuation">);</span>

<span class="name other">console</span><span class="punctuation">.</span><span class="name other">log</span><span class="punctuation">(</span><span class="name other">addon</span><span class="punctuation">.</span><span class="name other">hello</span><span class="punctuation">());</span>    <span class="comment single">// &quot;world&quot;</span>
</pre>
</div>
<hr class="docutils" />
<div class="section" id="upcoming-features">
<h1>Upcoming Features</h1>
<div class="system-message">
<p class="system-message-title">System Message: ERROR/3 (<tt class="docutils">presentation.rst</tt>, line 556)</p>
Document or section may not begin with a transition.</div>
</div>
<hr class="docutils" />
<div class="section" id="simd">
<h1>SIMD</h1>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>Single Instruction Multiple Data</p>
<img alt="SIMD.png" src="SIMD.png" />
<hr class="docutils" />
<pre class="code javascript literal-block">
<span class="comment single">// Classic method
</span><span class="name other">Vector</span><span class="punctuation">.</span><span class="name other">prototype</span><span class="punctuation">.</span><span class="name other">add</span> <span class="operator">=</span> <span class="keyword declaration">function</span><span class="punctuation">(</span><span class="name other">w</span><span class="punctuation">)</span> <span class="punctuation">{</span>
    <span class="keyword">this</span><span class="punctuation">.</span><span class="name other">x</span> <span class="operator">+=</span> <span class="name other">w</span><span class="punctuation">.</span><span class="name other">x</span><span class="punctuation">;</span>
    <span class="keyword">this</span><span class="punctuation">.</span><span class="name other">y</span> <span class="operator">+=</span> <span class="name other">w</span><span class="punctuation">.</span><span class="name other">y</span><span class="punctuation">;</span>
    <span class="keyword">this</span><span class="punctuation">.</span><span class="name other">z</span> <span class="operator">+=</span> <span class="name other">w</span><span class="punctuation">.</span><span class="name other">z</span><span class="punctuation">;</span>
<span class="punctuation">};</span>

<span class="comment single">// SIMD
</span><span class="name other">Vector</span><span class="punctuation">.</span><span class="name other">prototype</span><span class="punctuation">.</span><span class="name other">add</span> <span class="operator">=</span> <span class="keyword declaration">function</span><span class="punctuation">(</span><span class="name other">w</span><span class="punctuation">)</span> <span class="punctuation">{</span>
    <span class="keyword">this</span><span class="punctuation">.</span><span class="name other">v</span> <span class="operator">=</span> <span class="keyword">this</span><span class="punctuation">.</span><span class="name other">v</span><span class="punctuation">.</span><span class="name other">add</span><span class="punctuation">(</span><span class="name other">w</span><span class="punctuation">);</span>
<span class="punctuation">};</span>
</pre>
<hr class="docutils" />
<p>Very slow in V8, currently.</p>
<p><a class="reference external" href="http://peterjensen.github.io/mandelbrot/js/mandelbrot-ww-asm.html">SIMD example</a></p>
</div>
<hr class="docutils" />
<div class="section" id="links">
<h1>Links</h1>
<p><a class="reference external" href="https://medium.com/&#64;psiphi75/optimising-node-js-for-speed-part-1-19d72a085aba">https://medium.com/&#64;psiphi75/optimising-node-js-for-speed-part-1-19d72a085aba</a></p>
<p><a class="reference external" href="https://medium.com/&#64;psiphi75/optimising-node-js-for-speed-part-2-56e304bdc50f">https://medium.com/&#64;psiphi75/optimising-node-js-for-speed-part-2-56e304bdc50f</a></p>
<p><a class="reference external" href="https://medium.com/&#64;psiphi75/optimising-node-js-for-speed-part-3-aebd1c37fe6c">https://medium.com/&#64;psiphi75/optimising-node-js-for-speed-part-3-aebd1c37fe6c</a></p>
<p><a class="reference external" href="https://github.com/psiphi75/rtjsrt">https://github.com/psiphi75/rtjsrt</a></p>
</div>
<hr class="docutils" />
<div class="section" id="thanks">
<h1>Thanks</h1>
</div>
</div>
</body>
</html>
